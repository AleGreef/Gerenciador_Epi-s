{% extends "app_site/partials/base.html" %}
{% load static %}

{% block title %}Realizar Emprestimos{% endblock title %}

{% block content %}
<div class="container-fluid" >
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                {% if modo_edicao %}
                    Editar Empréstimo (ID: {{ emprestimo.id }})
                {% else %}
                    Realizar Empréstimo
                {% endif %}
            </h4>
            <a href="{% url 'colaboradores:listar_emprestimos' %}" class="btn btn-light btn-sm">Ver Lista</a>
        </div>


        <div class="card-body">
            <form method="POST" 
                action="{% if modo_edicao %}
                            {% url 'colaboradores:editar_emprestimo' emprestimo.id %}
                        {% else %}
                            {% url 'colaboradores:realizar_emprestimo' %}
                        {% endif %}">
                
                {% csrf_token %}
                
                <div class="mb-3">
                    <label class="form-label">Nome do Colaborador</label>
                    
                    <select id="nome_colaborador" name="nome_colaborador" class="form-control" 
                            {% if not modo_edicao %}required{% endif %} 
                            {% if modo_edicao %}disabled{% endif %}> 

                        <option value="">
                            {% if modo_edicao %}
                                {{ colaborador_atual.nome_colaborador }} (ID: {{ colaborador_atual.id_col }})
                            {% else %}
                                Selecione ou busque o colaborador
                            {% endif %}
                        </option>
                        </select>
                    
                    {% if modo_edicao %}
                        <input type="hidden" name="colaborador_id" value="{{ colaborador_atual.id_col }}">
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label">Nome do Equipamento</label>
                    
                    <select id="nome_epi" name="nome_epi" class="form-control" 
                            {% if not modo_edicao %}required{% endif %} 
                            {% if modo_edicao %}disabled{% endif %}>
                        
                        <option value="">
                            {% if modo_edicao %}
                                {{ equipamento_atual.nome_epi }} (ID: {{ equipamento_atual.id_epi }})
                            {% else %}
                                Selecione ou busque o equipamento
                            {% endif %}
                        </option>
                        </select>

                    {% if modo_edicao %}
                        <input type="hidden" name="epi_id" value="{{ equipamento_atual.id_epi }}">
                    {% endif %}
                </div>


                <div class="mb-3">
                    <label for="data_emprestimo" class="form-label">Data do empréstimo</label>
                    <input type="date" id="data_emprestimo" name="data_emprestimo" class="form-control" 
                           value="{{ emprestimo.data_emprestimo|date:'Y-m-d' }}" 
                           {% if modo_edicao %}readonly{% else %}required{% endif %}> </div>

                <div class="mb-3">
                    <label for="data_prevista" class="form-label">Data prevista para devolução</label>
                    <input type="date" id="data_prevista" name="data_prevista" class="form-control" 
                           value="{{ emprestimo.data_prevista|date:'Y-m-d' }}" 
                           {% if modo_edicao %}readonly{% else %}required{% endif %}> </div>
                
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select id="status" name="status" class="form-control" required>
                        <option value="">Selecione...</option>

                        <option value="emprestado" {% if emprestimo.status == "emprestado" %}selected{% endif %}>Emprestado</option>
                        <option value="fornecido" {% if emprestimo.status == "fornecido" %}selected{% endif %}>Fornecido</option>

                        {% if modo_edicao %}
                            <option value="devolvido" {% if emprestimo.status == "devolvido" %}selected{% endif %}>Devolvido</option>
                            <option value="danificado" {% if emprestimo.status == "danificado" %}selected{% endif %}>Danificado</option>
                            <option value="perdido" {% if emprestimo.status == "perdido" %}selected{% endif %}>Perdido</option>
                        {% endif %}
                    </select>
                </div>

                <div id="campos_devolucao" style="display:none;">
    
                    <div class="mb-3">
                        <label>Data de Devolução</label>
                        <input type="date" name="data_devolver" class="form-control" 
                            value="{{ emprestimo.data_devolver|date:'Y-m-d' }}">
                    </div>

                    <div class="mb-3">
                        <label>Observações</label>
                        <input type="text" name="observacoes" class="form-control"
                            value="{{ emprestimo.observacoes|default_if_none:'' }}"> </div>

                </div>

                <button type="submit" class="btn btn-primary">
                    {% if modo_edicao %}Atualizar Empréstimo{% else %}Cadastrar Empréstimo{% endif %}
                </button>
            </form>
        </div>
    </div>
</div>
{% block extra_js %}
<script>
    $(document).ready(function() {
    
    // Configuração Colaboradores (Somente se NÃO for modo de edição)
    {% if not modo_edicao %}
        $('#nome_colaborador').select2({
            placeholder: "Digite para buscar...",
            minimumInputLength: 1,
            ajax: {
                url: "{% url 'colaboradores:buscar_colaboradores' %}",
                dataType: 'json',
                delay: 300,
                data: params => ({ term: params.term }),
                processResults: function(data) {
                    return { results: data };
                }
            }
        });
    {% else %}
        // Se for edição, inicializa o Select2 sem AJAX, apenas com a opção atual
        $('#nome_colaborador').select2({
            placeholder: "{{ colaborador_atual.nome_colaborador }}",
            minimumResultsForSearch: Infinity, // Desabilita a busca se for somente leitura
            // Se o campo está 'disabled', o Select2 já deve funcionar como somente leitura
        });
    {% endif %}


    // Configuração Equipamentos (Somente se NÃO for modo de edição)
    {% if not modo_edicao %}
        $('#nome_epi').select2({
            placeholder: "Digite para buscar...",
            minimumInputLength: 1,
            ajax: {
                url: "{% url 'colaboradores:buscar_equipamentos' %}",
                dataType: 'json',
                delay: 300,
                data: params => ({ term: params.term }),
                processResults: function(data) {
                    return { results: data };
                }
            }
        });
    {% else %}
        // Se for edição, inicializa o Select2 sem AJAX, apenas com a opção atual
        // Este é um hack comum para Select2 em modo de edição/disabled:
        var option = new Option("{{ equipamento_atual.nome_epi }} (Atual)", "{{ equipamento_atual.id_epi }}", true, true);
        $('#nome_epi').append(option).trigger('change');
        $('#nome_epi').select2({
            minimumResultsForSearch: Infinity,
            placeholder: "{{ equipamento_atual.nome_epi }}",
        });
    {% endif %}


    // Campos de devolução (Lógica JavaScript OK)
    function atualizarCamposDevolucao() {
        const status = document.getElementById("status").value;
        const campos = document.getElementById("campos_devolucao");
        if (["devolvido", "danificado", "perdido"].includes(status)) {
            campos.style.display = "block";
        } else {
            campos.style.display = "none";
        }
    }
    document.getElementById("status").addEventListener("change", atualizarCamposDevolucao);
    atualizarCamposDevolucao();
});

</script>

{% endblock %}
{% endblock content %}