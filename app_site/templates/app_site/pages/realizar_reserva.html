{% extends "app_site/partials/base.html" %}
{% load static %}

{% block title %}Reservas de EPI{% endblock title %}

{% block content %}

<div class="container" style="margin-left: 260px; margin-top: 40px;">

    <h3>Reservas de EPIs</h3>

    <!-- MENSAGENS -->
    {% if messages %}
        {% for msg in messages %}
            <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
        {% endfor %}
    {% endif %}

    <!-- FORM CADASTRO / EDIÇÃO -->
    <form method="POST" id="formReserva">
        {% csrf_token %}
        <input type="hidden" name="id_reserva" id="id_reserva">

        <div class="row">

            <!-- COLABORADOR -->
            <div class="col-md-6">
                <label>Colaborador</label>
                <select name="colaborador" id="colaborador" class="form-control" required>
                    <option value="">Selecione</option>
                    {% for c in colaboradores %}
                        <option value="{{ c.id_col }}">{{ c.nome_colaborador }} - CPF: {{ c.cpf }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- EPI -->
            <div class="col-md-6">
                <label>EPI</label>
                <select name="epi" id="epi" class="form-control" required>
                    <option value="">Selecione</option>
                    {% for e in epis %}
                        <option value="{{ e.id_epis }}">
                            {{ e.nome_epi }} - Tam: {{ e.tamanho }} - Saldo: {{ e.saldo }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- QUANTIDADE -->
            <div class="col-md-4 mt-3">
                <label>Quantidade</label>
                <input type="number" name="quantidade" id="quantidade" class="form-control" min="1" required>
            </div>

            <!-- DATA RETIRADA -->
            <div class="col-md-4 mt-3">
                <label>Data de Retirada</label>
                <input type="date" name="data_retirada" id="data_retirada" class="form-control" required>
            </div>

            <!-- DATA DEVOLUÇÃO -->
            <div class="col-md-4 mt-3">
                <label>Data de Devolução</label>
                <input type="date" name="data_devolucao" id="data_devolucao" class="form-control">
            </div>

            <!-- STATUS -->
            <div class="col-md-4 mt-3">
                <label>Status</label>
                <select name="status" id="status" class="form-control" required>
                    <option value="Reservado">Reservado</option>
                    <option value="Emprestado">Emprestado</option>
                    <option value="Devolvido">Devolvido</option>
                </select>
            </div>
        </div>

        <div class="mt-4 d-flex gap-2">
    <button class="btn btn-primary mr-2" name="acao" value="salvar" type="submit">
        Salvar / Atualizar
    </button>

    <button class="btn btn-danger" name="acao" value="excluir" type="submit">
        Excluir Reserva
    </button>
</div>

    </form>

    <hr>

    <!-- GRID -->
    <h4 class="mt-4">Reservas cadastradas</h4>
    <table class="table table-striped table-bordered mt-3">
        <thead>
            <tr>
                <th>ID</th>
                <th>Colaborador</th>
                <th>EPI</th>
                <th>Quantidade</th>
                <th>Retirada</th>
                <th>Devolução</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for r in reservas %}
                <tr class="linha-reserva"
    data-id="{{ r.id_reserva }}"
    data-colaborador="{{ r.cpf }}"
    data-epi="{{ r.cod_epi }}"
    data-quantidade="{{ r.quantidade }}"
    data-retirada="{{ r.data_retirada|date:'Y-m-d' }}"
    data-devolucao="{{ r.data_devolucao|date:'Y-m-d' }}"
    data-status="{{ r.status }}"
    style="cursor:pointer">

                    <td>{{ r.id_reserva }}</td>
                    <td>{{ r.cpf }}</td>
                    <td>{{ r.cod_epi }}</td>
                    <td>{{ r.quantidade }}</td>
                    <td>{{ r.data_retirada }}</td>
                    <td>{{ r.data_devolucao }}</td>
                    <td>{{ r.status }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<script>
document.querySelectorAll(".linha-reserva").forEach(row => {
    row.addEventListener("click", () => {

        // Campos simples
        document.getElementById("id_reserva").value = row.dataset.id;
        document.getElementById("quantidade").value = row.dataset.quantidade;
        document.getElementById("data_retirada").value = row.dataset.retirada;
        document.getElementById("data_devolucao").value = row.dataset.devolucao;
        document.getElementById("status").value = row.dataset.status;

        // SELECT COLABORADOR
        document.querySelector("#colaborador").value = row.dataset.colaborador;

        // SELECT EPI
        document.querySelector("#epi").value = row.dataset.epi;
    });
});
</script>


{% endblock content %}
