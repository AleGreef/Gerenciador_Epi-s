{% extends "app_site/partials/base.html" %}
{% load static %}

{% block title %}Realizar Reserva{% endblock title %}

{% block content %}

<div class="container" style="margin-left: 260px; margin-top: 40px;">

    <h2>Reservas de EPI</h2>

    <!-- Formulário -->
    <form method="POST" class="mt-4">
        {% csrf_token %}

        <input type="hidden" id="id_reserva" name="id_reserva">

        <div class="row">

            <!-- Colaborador -->
            <div class="col-md-4">
                <label>Colaborador</label>
                <select id="colaborador" name="colaborador" class="form-control" required>
                    <option value="">Selecione...</option>
                    {% for c in colaboradores %}
                    <option value="{{ c.id_col }}">{{ c.nome_colaborador }} ({{ c.cpf }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- EPI -->
            <div class="col-md-4">
                <label>EPI</label>
                <select id="epi" name="epi" class="form-control" required>
                    <option value="">Selecione...</option>
                    {% for e in epis %}
                    <option value="{{ e.id_epis }}">{{ e.nome_epi }} ({{ e.tamanho }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Quantidade -->
            <div class="col-md-4">
                <label>Quantidade</label>
                <input type="number" name="quantidade" id="quantidade" min="1" class="form-control" required>
            </div>
        </div>

        <div class="row mt-3">

            <!-- Data Retirada -->
            <div class="col-md-4">
                <label>Data Retirada</label>
                <input type="date" name="data_retirada" id="data_retirada" class="form-control" required>
            </div>

            <!-- Data Devolução -->
            <div class="col-md-4">
                <label>Data Devolução</label>
                <input type="date" name="data_devolucao" id="data_devolucao" class="form-control">
            </div>

            <!-- Status -->
            <div class="col-md-4">
                <label>Status</label>
                <select id="status" name="status" class="form-control" required>
                    <option value="reservado">Reservado</option>
                    <option value="emprestado">Emprestado</option>
                    <option value="devolvido">Devolvido</option>
                </select>
            </div>

        </div>

        <!-- BOTÕES -->
        <div class="row mt-4">
            <div class="col-md-12 d-flex" style="gap: 10px;">
                <button type="submit" name="acao" value="salvar" class="btn btn-success w-25">Salvar</button>
                <button type="submit" name="acao" value="excluir" class="btn btn-danger w-25" id="btnExcluir" disabled>
                    Excluir
                </button>
                <button type="button" class="btn btn-secondary w-25" onclick="limparFormulario()">
                    Limpar
                </button>
            </div>
        </div>

    </form>

    <hr class="mt-4">

    <!-- Listagem das Reservas -->
    <h3>Reservas Cadastradas</h3>

    <table class="table table-striped table-bordered mt-3">
        <thead>
            <tr>
                <th>ID</th>
                <th>Colaborador</th>
                <th>EPI</th>
                <th>Quantidade</th>
                <th>Retirada</th>
                <th>Devolução</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for r in reservas %}
            <tr class="linha-reserva"

                data-id="{{ r.id_reserva }}"

                data-colaborador="
                {% for c in colaboradores %}
                    {% if c.cpf == r.cpf %}
                        {{ c.id_col }}
                    {% endif %}
                {% endfor %}
                "

                data-epi="{{ r.cod_epi }}"
                data-quantidade="{{ r.quantidade }}"
                data-retirada="{{ r.data_retirada }}"
                data-devolucao="{{ r.data_devolucao }}"
                data-status="{{ r.status }}"
                style="cursor: pointer;">

                <td>{{ r.id_reserva }}</td>

                <td>
                    {% for c in colaboradores %}
                        {% if c.cpf == r.cpf %}
                            {{ c.nome_colaborador }}
                        {% endif %}
                    {% endfor %}
                </td>

                <td>
                    {% for e in epis %}
                        {% if e.id_epis == r.cod_epi %}
                            {{ e.nome_epi }}
                        {% endif %}
                    {% endfor %}
                </td>

                <td>{{ r.quantidade }}</td>
                <td>{{ r.data_retirada }}</td>
                <td>{{ r.data_devolucao }}</td>
                <td>{{ r.status }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</div>

<script>

// Preencher o formulário ao clicar na linha
document.querySelectorAll(".linha-reserva").forEach(function(row) {
    row.addEventListener("click", function() {

        document.getElementById("id_reserva").value = this.dataset.id;
        document.getElementById("colaborador").value = this.dataset.colaborador.trim();
        document.getElementById("epi").value = this.dataset.epi;

        document.getElementById("quantidade").value = this.dataset.quantidade;
        document.getElementById("data_retirada").value = this.dataset.retirada;
        document.getElementById("data_devolucao").value = this.dataset.devolucao;
        document.getElementById("status").value = this.dataset.status;

        // Desabilitar campos que não podem ser alterados
        document.getElementById("colaborador").disabled = true;
        document.getElementById("epi").disabled = true;

        // Habilitar excluir
        document.getElementById("btnExcluir").disabled = false;
    });
});

// Limpar formulário
function limparFormulario() {
    document.getElementById("id_reserva").value = "";
    document.getElementById("colaborador").value = "";
    document.getElementById("epi").value = "";
    document.getElementById("quantidade").value = "";
    document.getElementById("data_retirada").value = "";
    document.getElementById("data_devolucao").value = "";
    document.getElementById("status").value = "reservado";

    document.getElementById("colaborador").disabled = false;
    document.getElementById("epi").disabled = false;
    document.getElementById("btnExcluir").disabled = true;
}

</script>

{% endblock content %}
